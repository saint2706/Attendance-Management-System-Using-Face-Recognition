name: Frontend CI

on:
  push:
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-ci.yml'
  pull_request:
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-ci.yml'

jobs:
  frontend-quality:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          if [ "$ACT" = "true" ]; then
            echo "Running in act mode - using workaround for npm signal handling issues"
            # npm has a bug with act where exit handlers fail. We work around this by:
            # 1. Running npm with a long timeout (npm takes longer in act)
            # 2. Ignoring the exit handler error since installation still completes
            # 3. Checking if installation succeeded by verifying key binaries exist
            
            timeout 180 npm install --prefer-offline --no-audit --no-fund --loglevel=error > /tmp/npm-install.log 2>&1 || true
            
            # Check if installation actually succeeded by verifying key binaries exist
            if [ -f "node_modules/.bin/eslint" ] && [ -f "node_modules/.bin/vite" ]; then
              echo "Dependencies installed successfully"
              rm -f /tmp/npm-install.log
            else
              echo "npm install incomplete. Checking status..."
              if [ -d "node_modules" ]; then
                echo "node_modules exists with $(ls node_modules | wc -l) packages"
                echo "Waiting a bit more for npm to finish..."
                sleep 10
                if [ -f "node_modules/.bin/eslint" ]; then
                  echo "Dependencies installed successfully after wait"
                else
                  echo "Installation failed. Log:"
                  tail -50 /tmp/npm-install.log || true
                  exit 1
                fi
              else
                echo "Installation completely failed"
                exit 1
              fi
            fi
          else
            npm ci
          fi

      - name: Prepare log directory
        run: mkdir -p .ci-logs

      - name: Lint
        run: |
          set -o pipefail
          npm run lint 2>&1 | tee .ci-logs/lint.log

      - name: Build
        run: |
          set -o pipefail
          npm run build 2>&1 | tee .ci-logs/build.log

      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-logs
          path: frontend/.ci-logs/*.log
          if-no-files-found: ignore
