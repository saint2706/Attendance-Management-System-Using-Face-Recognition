{% extends "recognition/base.html" %}
{% load static crispy_forms_tags %}

{% block title %}Add Photos - Smart Attendance System{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-md-10 col-lg-8 col-xl-6">
        <article class="card card-elevated">
            <div class="card-body card-body-lg">
                <div class="text-center mb-8">
                    <i class="fas fa-camera icon-hero text-primary mb-4" aria-hidden="true"></i>
                    <h1 class="text-3xl font-weight-bold mb-3">
                        Add Employee Photos
                    </h1>
                    <p class="text-muted text-base max-w-600 mx-auto mb-0">
                        Enter the username of the employee to begin capturing photos for face recognition.
                        The webcam will activate upon submission and capture multiple photos for training.
                    </p>
                </div>

                {% if task %}
                    <div class="alert alert-info text-start" role="status">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h2 class="h5 mb-0">Capture Task Status</h2>
                            <code class="text-sm">{{ task.task_id }}</code>
                        </div>
                        <p class="mb-2">
                            Current state: <strong class="text-uppercase">{{ task.status }}</strong>
                            {% if task.ready %}
                                {% if task.successful %}
                                    – capture completed successfully.
                                {% else %}
                                    – the task encountered an error.
                                {% endif %}
                            {% else %}
                                – processing in background.
                            {% endif %}
                        </p>
                        {% if task.error %}
                            <p class="mb-2 text-danger">{{ task.error }}</p>
                        {% endif %}
                        {% if task.result %}
                            <dl class="row small mb-0">
                                <dt class="col-6">Frames captured</dt>
                                <dd class="col-6">{{ task.result.frames_captured|default:"–" }}</dd>
                                <dt class="col-6">Images saved</dt>
                                <dd class="col-6">{{ task.result.images_saved|default:"–" }}</dd>
                            </dl>
                        {% elif task.meta %}
                            <p class="mb-0 small text-muted">Latest update: {{ task.meta }}</p>
                        {% endif %}
                        <p class="mb-0 small mt-3">
                            Poll <code>{{ request.scheme }}://{{ request.get_host }}{% url 'task-status' task.task_id %}</code>
                            to retrieve JSON status updates.
                        </p>
                    </div>
                {% endif %}

                <form method="POST" data-validate="true">
                    {% csrf_token %}
                    <fieldset>
                        {{ form|crispy }}
                    </fieldset>
                    <div class="d-grid gap-3 mt-8">
                        <button class="btn btn-primary btn-lg" type="submit">
                            <i class="fas fa-camera" aria-hidden="true"></i> Start Camera
                        </button>
                        <button
                            class="btn btn-outline-primary btn-lg"
                            type="button"
                            data-camera-preview-trigger
                        >
                            <i class="fas fa-video" aria-hidden="true"></i> Preview Camera
                        </button>
                        <a href="{% url 'dashboard' %}" class="btn btn-secondary btn-lg">
                            <i class="fas fa-arrow-left" aria-hidden="true"></i> Back to Dashboard
                        </a>
                    </div>
                </form>
            </div>
        </article>

        <!-- Camera Preview Modal (camera-modal/camera-preview classes keep responsive sizing) -->
        <div
            class="modal fade"
            id="cameraPreviewModal"
            tabindex="-1"
            aria-labelledby="cameraPreviewModalLabel"
            aria-hidden="true"
        >
            <div class="modal-dialog modal-dialog-centered modal-lg camera-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title h5" id="cameraPreviewModalLabel">Camera Preview</h2>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="camera-preview">
                            <video
                                id="cameraPreview"
                                class="w-100 h-100"
                                autoplay
                                muted
                                playsinline
                                data-camera-preview
                            ></video>
                            <div class="camera-loader position-absolute top-50 start-50 translate-middle text-center" data-camera-loader>
                                <div class="spinner-border text-light mb-2" role="status" style="width: 3rem; height: 3rem;">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="text-light mb-0">Initializing camera...</p>
                            </div>
                        </div>
                        <div class="alert alert-danger mt-3 d-none" role="alert" data-camera-error></div>
                        <p class="text-muted small mt-3 mb-0">
                            Grant camera permissions when prompted. The preview stops automatically once you close this dialog.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-xmark" aria-hidden="true"></i> Close Preview
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Instructions Card -->
        <div class="card card-accent card-accent--info mt-6">
            <div class="card-body card-body-lg">
                <h2 class="d-flex align-items-center gap-2 mb-4 text-xl font-weight-semibold">
                    <i class="fas fa-lightbulb text-info" aria-hidden="true"></i>
                    <span>Photo Capture Tips</span>
                </h2>
                <ul class="list-spaced text-muted text-sm mb-3">
                    <li>Ensure good lighting conditions for better recognition accuracy</li>
                    <li>Position the face clearly in front of the camera</li>
                    <li>Remove any obstructions like sunglasses or hats</li>
                    <li>Multiple photos will be captured automatically from different angles</li>
                    <li>The system will train automatically once photos are added</li>
                </ul>
                <a href="https://github.com/saint2706/Attendance-Management-System-Using-Face-Recognition/blob/main/USER_GUIDE.md#adding-employee-photos" target="_blank" class="text-sm">
                    <i class="fas fa-book me-1" aria-hidden="true"></i>See full instructions in the User Guide
                </a>
            </div>
        </div>

        <!-- Security Note -->
        <div class="card card-muted mt-6">
            <div class="card-body card-body-tight">
                <div class="d-flex align-items-start gap-3">
                    <i class="fas fa-shield-halved icon-lg text-success" aria-hidden="true"></i>
                    <div>
                        <h3 class="text-base font-weight-semibold mb-2">
                            Privacy &amp; Consent
                        </h3>
                        <p class="text-muted text-sm mb-2">
                            All facial data is encrypted and stored securely. Photos are used solely for attendance recognition purposes 
                            and are protected according to data privacy regulations. By submitting photos, the employee consents to 
                            biometric data processing for attendance verification.
                        </p>
                        <div class="d-flex gap-3 flex-wrap">
                            <a href="https://github.com/saint2706/Attendance-Management-System-Using-Face-Recognition/blob/main/DATA_CARD.md" target="_blank" rel="noopener" class="text-sm">
                                <i class="fas fa-database me-1" aria-hidden="true"></i>Data Card
                            </a>
                            <a href="https://github.com/saint2706/Attendance-Management-System-Using-Face-Recognition/blob/main/docs/FAIRNESS_AND_LIMITATIONS.md" target="_blank" rel="noopener" class="text-sm">
                                <i class="fas fa-balance-scale me-1" aria-hidden="true"></i>Fairness &amp; Limitations
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
    {{ block.super }}
<script type="module">
    import { CameraManager } from "{% static 'js/camera.js' %}";

    document.addEventListener("DOMContentLoaded", () => {
        const modalElement = document.getElementById("cameraPreviewModal");
        const previewButton = document.querySelector("[data-camera-preview-trigger]");
        const errorAlert = modalElement?.querySelector("[data-camera-error]");
        const previewVideo = modalElement?.querySelector("[data-camera-preview]");
        const loader = modalElement?.querySelector("[data-camera-loader]");

        if (!modalElement || !window.bootstrap) {
            return;
        }

        const cameraManager = new CameraManager();
        const bootstrapModal = window.bootstrap.Modal.getOrCreateInstance(modalElement);

        const hideError = () => {
            if (errorAlert) {
                errorAlert.classList.add("d-none");
                errorAlert.textContent = "";
            }
        };

        const showError = (message) => {
            if (!errorAlert) {
                return;
            }
            errorAlert.textContent = message;
            errorAlert.classList.remove("d-none");
        };

        const setLoader = (isLoading) => {
            if (loader) {
                if (isLoading) {
                    loader.classList.remove("d-none");
                } else {
                    loader.classList.add("d-none");
                }
            }
        };

        if (previewButton) {
            const cameraSupported = Boolean(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            if (!cameraSupported) {
                previewButton.disabled = true;
                previewButton.title = "Camera preview is not supported in this browser.";
            }

            previewButton.addEventListener("click", (event) => {
                event.preventDefault();
                hideError();
                bootstrapModal.show();
            });
        }

        modalElement.addEventListener("shown.bs.modal", async () => {
            hideError();
            setLoader(true);

            if (!previewVideo) {
                return;
            }

            const onPlaying = () => {
                setLoader(false);
                previewVideo.removeEventListener("playing", onPlaying);
            };
            previewVideo.addEventListener("playing", onPlaying);

            try {
                await cameraManager.start(previewVideo);
            } catch (error) {
                cameraManager.stop();
                setLoader(false);
                previewVideo.removeEventListener("playing", onPlaying);
                showError(error?.message || "Unable to access the camera. Please check your browser permissions.");
            }
        });

        const teardown = () => {
            hideError();
            cameraManager.stop();
        };

        modalElement.addEventListener("hidden.bs.modal", teardown);

        window.addEventListener("beforeunload", () => cameraManager.stop());
        window.addEventListener("pagehide", () => cameraManager.stop());
        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "hidden") {
                cameraManager.stop();
            }
        });
    });
</script>
{% endblock %}
